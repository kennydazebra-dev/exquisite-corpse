<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Salon Co-Story</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      font-family: Georgia, serif;
      background: #fdfaf6;
      color: #1a1a1a;
      display: flex;
      justify-content: center;
      padding: 60px 20px;
    }

    .container {
      max-width: 650px;
      width: 100%;
    }

    h1 {
      text-align: center;
      font-weight: normal;
      letter-spacing: 2px;
      margin-bottom: 40px;
    }

    .story-box {
      background: #ffffff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.05);
      margin-bottom: 30px;
      min-height: 100px;
    }

    textarea {
      width: 100%;
      height: 140px;
      padding: 15px;
      font-family: Georgia, serif;
      font-size: 16px;
      border-radius: 10px;
      border: 1px solid #ddd;
      resize: none;
      outline: none;
      transition: all 0.2s ease;
    }

    textarea:disabled {
      background: #f3f3f3;
      cursor: not-allowed;
    }

    button {
      margin-top: 15px;
      padding: 10px 18px;
      font-family: Georgia, serif;
      background: #1a1a1a;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: opacity 0.2s ease;
    }

    button:hover {
      opacity: 0.85;
    }

    #counter {
      margin-top: 8px;
      font-size: 0.85em;
      color: #666;
    }
  </style>
</head>
<body>

<div class="container">
  <h1>Salon Co-Story</h1>

  <div class="story-box" id="latestText">
    Loading...
  </div>

  <textarea id="newText" maxlength="1500" placeholder="Continue the story..."></textarea>
  <div id="counter">0 words · 0 / 1500 characters</div>
  <button onclick="submitText()">Add to the Story</button>
</div>

<script>
  const SUPABASE_URL = "https://oknklrirjobjxkszvuti.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rbmtscmlyam9ianhrc3p2dXRpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3OTY1MDIsImV4cCI6MjA4NzM3MjUwMn0.2klLdEHJykXAQUKWtlrV-SWJPS8gPQml-UWw2YnXKt4";

  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const textarea = document.getElementById("newText");
  const counter = document.getElementById("counter");

  const LOCK_ID = 1;
  const LOCK_DURATION = 10 * 60 * 1000; // 10 minutes

  // Load latest submission
  async function loadLatest() {
    const { data } = await supabaseClient
      .from("submissions")
      .select("*")
      .order("created_at", { ascending: false })
      .limit(1);

    document.getElementById("latestText").innerText =
      data && data.length > 0
        ? data[0].text
        : "The story begins here...";
  }

  // Word + character counter
  textarea.addEventListener("input", async () => {
    const text = textarea.value;

    const charCount = text.length;
    const wordCount = text.trim() === ""
      ? 0
      : text.trim().split(/\s+/).length;

    counter.innerText = `${wordCount} words · ${charCount} / 1500 characters`;

    // Attempt to claim lock
    const { data } = await supabaseClient
      .from("writing_lock")
      .select("*")
      .eq("id", LOCK_ID)
      .single();

    if (data && !data.is_locked) {
      await supabaseClient
        .from("writing_lock")
        .update({ is_locked: true, locked_at: new Date() })
        .eq("id", LOCK_ID);
    }
  });

  // Check lock status
  async function checkLock() {
    const { data } = await supabaseClient
      .from("writing_lock")
      .select("*")
      .eq("id", LOCK_ID)
      .single();

    if (!data) return;

    const now = new Date();
    const lockedAt = data.locked_at ? new Date(data.locked_at) : null;

    if (data.is_locked && lockedAt) {
      const timePassed = now - lockedAt;

      if (timePassed > LOCK_DURATION) {
        // Auto unlock
        await supabaseClient
          .from("writing_lock")
          .update({ is_locked: false, locked_at: null })
          .eq("id", LOCK_ID);

        textarea.disabled = false;
        textarea.placeholder = "Continue the story...";
      } else {
        textarea.disabled = true;
        textarea.placeholder = "Another writer is currently composing...";
      }
    } else {
      textarea.disabled = false;
      textarea.placeholder = "Continue the story...";
    }
  }

  // Submit text
  async function submitText() {
    const text = textarea.value.trim();
    if (!text) return;

    await supabaseClient.from("submissions").insert([{ text }]);

    await supabaseClient
      .from("writing_lock")
      .update({ is_locked: false, locked_at: null })
      .eq("id", LOCK_ID);

    textarea.value = "";
    counter.innerText = "0 words · 0 / 1500 characters";

    loadLatest();
  }

  setInterval(checkLock, 3000);
  checkLock();
  loadLatest();
</script>

</body>
</html>
